<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KahvaltÄ± Malzeme SeÃ§imi</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          margin: 20px;
      }
      table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
      }
      th, td {
          border: 1px solid #ddd;
          padding: 10px;
          text-align: left;
      }
      th {
          background-color: #f4f4f4;
      }
      .taken {
          background-color: #d4edda;
      }
      .add-button, .reset-button, .edit-button, .random-button {
          padding: 10px 20px;
          background-color: #007bff;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
      }
      .reset-button {
          background-color: #ff4d4d;
      }
      .reset-button:hover {
          background-color: #ff3333;
      }
      .add-button:hover, .edit-button:hover, .random-button:hover {
          background-color: #0056b3;
      }
      .button-container {
          display: flex;
          justify-content: space-between;
          margin-top: 20px;
      }
      .left-buttons {
          display: flex;
          gap: 10px;
      }
      .add-button:before {
          content: "+ ";
      }
      .edit-button:before {
          content: "âœ ";
      }
      .random-button {
          /* Zar simgesi HTML iÃ§inde direkt metin olarak eklendi */
      }
      #etkinlikPanosu {
          position: absolute;
          top: 20px;
          right: 20px;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          background-color: #f9f9f9;
          box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
      }
      #etkinlikPanosu span {
          margin: 0 5px;
      }
  </style>
</head>
<body>
  <h1>KahvaltÄ± Malzeme SeÃ§imi</h1>
  <p>GetireceÄŸiniz malzemenin karÅŸÄ±sÄ±na adÄ±nÄ±zÄ± yazÄ±n. SeÃ§im yaptÄ±ÄŸÄ±nÄ±zda diÄŸer kiÅŸiler bu malzemeyi seÃ§emez.</p>

  <table id="malzemeListesi"></table>

  <div class="button-container">
      <div class="left-buttons">
          <button class="random-button" onclick="rastgeleSecim()">ğŸ² Rastgele SeÃ§im Yap</button>
          <button class="add-button" onclick="addMalzeme()">Yeni Malzeme Ekle</button>
          <button class="edit-button" onclick="editPano()">Etkinlik Bilgilerini DÃ¼zenle</button>
      </div>
      <button class="reset-button" onclick="sifirla()">TÃ¼m SeÃ§imleri SÄ±fÄ±rla</button>
  </div>

  <div id="etkinlikPanosu"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove, get, update } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";

    // Firebase yapÄ±landÄ±rma
    const firebaseConfig = {
      apiKey: "AIzaSy...",
      authDomain: "kahvalti-secim-sitesi.firebaseapp.com",
      databaseURL: "https://kahvalti-secim-sitesi-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kahvalti-secim-sitesi",
      storageBucket: "kahvalti-secim-sitesi.appspot.com",
      messagingSenderId: "1023667017125",
      appId: "1:1023667017125:web:f4b4dbca4c31825ca2e24c"
    };

    // Firebase'i baÅŸlat
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // YÃ¶netici parolasÄ± (Ã–rnek: 12345)
    const ADMIN_PASSWORD = "cemal1905";

    // Basit parola doÄŸrulama fonksiyonu
    function checkPassword() {
      const input = prompt("Bu iÅŸlemi yapmak iÃ§in yÃ¶netici parolasÄ±nÄ± girin:");
      if (!input) {
        return false;
      }
      if (input === ADMIN_PASSWORD) {
        return true;
      } else {
        alert("YanlÄ±ÅŸ parola!");
        return false;
      }
    }

    // Default malzemeler: veritabanÄ± anahtarÄ± (key), gÃ¶sterim adÄ± (label) ve seÃ§im limiti (max)
    const defaultMalzemeler = [
      { key: "beyaz_peynir", label: "Beyaz Peynir", max: 1 },
      { key: "borek", label: "BÃ¶rek (3 kiÅŸiye kadar seÃ§ilebilir)", max: 3 },
      { key: "kasar_peynir", label: "KaÅŸar Peynir", max: 1 },
      { key: "siyah_zeytin", label: "Siyah Zeytin", max: 1 },
      { key: "salatalik", label: "SalatalÄ±k", max: 1 },
      { key: "domates", label: "Domates", max: 1 },
      { key: "simit", label: "Simit (15 Adet)", max: 1 },
      { key: "kaymak", label: "Kaymak", max: 1 },
      { key: "nutella", label: "Nutella", max: 1 },
      { key: "ac_bitir_salam", label: "AÃ§ Bitir Salam (Maks. 3 adet)", max: 1 },
      { key: "kuru_yemis", label: "Kuru YemiÅŸ", max: 1 },
      { key: "biber", label: "Biber", max: 1 },
      { key: "yesil_zeytin", label: "YeÅŸil Zeytin", max: 1 },
      { key: "bal", label: "Bal", max: 1 }
    ];

    const malzemeListesi = document.getElementById('malzemeListesi');
    const etkinlikPanosu = document.getElementById('etkinlikPanosu');

    const dbRef = ref(database, 'kahvaltiListesi');
    const panoRef = ref(database, 'etkinlikPanosu');

    // Tabloyu gÃ¼ncelleyen fonksiyon
    const updateTable = (data) => {
      malzemeListesi.innerHTML = '';

      // Default malzemeleri key bazÄ±nda iÃ§eren obje oluÅŸturuluyor
      const defaultData = defaultMalzemeler.reduce((acc, item) => {
        acc[item.key] = [];
        return acc;
      }, {});

      // Firebase'den gelen verilerle birleÅŸtiriliyor
      const allMalzemeler = { ...defaultData, ...data };

      Object.entries(allMalzemeler).forEach(([key, kisiler]) => {
        // Default listede varsa malzemenin etiketini ve limitini al, yoksa key'i kullan
        const malzemeObj = defaultMalzemeler.find(item => item.key === key) || { key: key, label: key, max: 1 };

        const row = document.createElement('tr');

        const malzemeCell = document.createElement('td');
        malzemeCell.textContent = malzemeObj.label;
        row.appendChild(malzemeCell);

        const kisiCell = document.createElement('td');
        kisiCell.textContent = Array.isArray(kisiler)
          ? kisiler.map(k => k.charAt(0).toUpperCase() + k.slice(1)).join(', ')
          : '';
        kisiCell.classList.add('kisiler');
        row.appendChild(kisiCell);

        const buttonCell = document.createElement('td');
        const button = document.createElement('button');
        button.textContent = kisiler && kisiler.length >= malzemeObj.max ? 'SeÃ§ildi' : 'SeÃ§';
        button.disabled = kisiler && kisiler.length >= malzemeObj.max;
        button.onclick = () => secMalzeme(key);
        buttonCell.appendChild(button);

        const editButton = document.createElement('button');
        editButton.textContent = 'SeÃ§imi KaldÄ±r';
        // Parola kontrolÃ¼ ve onaylama sÄ±rasÄ±: Ã¶nce parola, sonra confirm
        editButton.onclick = () => {
          if (!checkPassword()) return;
          if (confirm(`${malzemeObj.label} seÃ§imini silmek istediÄŸinizden emin misiniz?`)) {
            editMalzeme(key);
          }
        };
        buttonCell.appendChild(editButton);

        row.appendChild(buttonCell);
        malzemeListesi.appendChild(row);
      });
    };

    // Etkinlik panosunu gÃ¼ncelleyen fonksiyon
    const updatePano = (data) => {
      etkinlikPanosu.innerHTML = `
        <span><b>Tarih:</b> ${data?.tarih || ''}</span>
        <span><b>Saat:</b> ${data?.saat || ''}</span>
        <span><b>Yer:</b> ${data?.yer || ''}</span>
      `;
    };

    // Firebase verilerini canlÄ± dinleme
    onValue(dbRef, (snapshot) => {
      const data = snapshot.val() || {};
      updateTable(data);
    });

    onValue(panoRef, (snapshot) => {
      const data = snapshot.val();
      updatePano(data);
    });

    // Malzeme seÃ§im fonksiyonu (tek kelime, yalnÄ±zca harf, ilk harf bÃ¼yÃ¼k)
    window.secMalzeme = async (key) => {
      const isim = prompt('LÃ¼tfen isminizi girin:');
      if (!isim) {
        alert('GeÃ§erli bir isim girin!');
        return;
      }

      const trimmedIsim = isim.trim();
      const pattern = /^[a-zA-ZÄ±ÄŸÃ¼ÅŸÃ¶Ã§Ä°ÄÃœÅÃ–Ã‡]+$/;
      if (!pattern.test(trimmedIsim)) {
        alert("GeÃ§erli bir isim girin! (Sadece tek kelime, boÅŸluk ve noktalama yok)");
        return;
      }

      const formattedIsim =
        trimmedIsim.charAt(0).toUpperCase() +
        trimmedIsim.slice(1).toLowerCase();

      try {
        const snapshot = await get(dbRef);
        const data = snapshot.val() || {};
        const kisiler = data[key] || [];

        // AynÄ± isim baÅŸka malzemede var mÄ±?
        if (Object.values(data).flat().includes(formattedIsim)) {
          alert(`Bu isim (${formattedIsim}) zaten baÅŸka bir malzeme iÃ§in seÃ§im yaptÄ±!`);
          return;
        }

        // Malzeme kapasitesi dolu mu?
        const malzemeObj = defaultMalzemeler.find(item => item.key === key) || { label: key, max: 1 };
        if (kisiler.length >= malzemeObj.max) {
          alert(`${malzemeObj.label} iÃ§in maksimum kiÅŸi sayÄ±sÄ±na ulaÅŸÄ±ldÄ±!`);
          return;
        }

        // SeÃ§imi veritabanÄ±na kaydet
        kisiler.push(formattedIsim);
        await set(ref(database, `kahvaltiListesi/${key}`), kisiler);
        alert(`${malzemeObj.label} iÃ§in seÃ§im kaydedildi.`);
      } catch (error) {
        alert('Bir hata oluÅŸtu: ' + error.message);
      }
    };

    // Rastgele seÃ§im butonunun fonksiyonu
    window.rastgeleSecim = async () => {
      const isim = prompt('LÃ¼tfen isminizi girin:');
      if (!isim) {
        alert('GeÃ§erli bir isim girin!');
        return;
      }

      const trimmedIsim = isim.trim();
      const pattern = /^[a-zA-ZÄ±ÄŸÃ¼ÅŸÃ¶Ã§Ä°ÄÃœÅÃ–Ã‡]+$/;
      if (!pattern.test(trimmedIsim)) {
        alert("GeÃ§erli bir isim girin! (Sadece tek kelime, boÅŸluk ve noktalama yok)");
        return;
      }

      const formattedIsim =
        trimmedIsim.charAt(0).toUpperCase() +
        trimmedIsim.slice(1).toLowerCase();

      try {
        // Verileri Ã§ek
        const snapshot = await get(dbRef);
        const data = snapshot.val() || {};

        // Bu isim zaten baÅŸka bir malzeme seÃ§miÅŸ mi?
        if (Object.values(data).flat().includes(formattedIsim)) {
          alert(`Bu isim (${formattedIsim}) zaten baÅŸka bir malzeme iÃ§in seÃ§im yaptÄ±!`);
          return;
        }

        // TÃ¼m malzemeleri (default + veritabanÄ±) birleÅŸtir
        const defaultData = defaultMalzemeler.reduce((acc, item) => {
          acc[item.key] = [];
          return acc;
        }, {});
        const allMalzemeler = { ...defaultData, ...data };

        // Kapasitesi dolmamÄ±ÅŸ malzemeleri filtrele
        const availableItems = Object.entries(allMalzemeler).filter(([key, kisiler]) => {
          const malzemeObj = defaultMalzemeler.find(item => item.key === key) || { label: key, max: 1 };
          return kisiler.length < malzemeObj.max;
        });

        if (availableItems.length === 0) {
          alert('SeÃ§ilebilecek uygun malzeme kalmadÄ±!');
          return;
        }

        // Rastgele bir malzeme seÃ§
        const randomIndex = Math.floor(Math.random() * availableItems.length);
        const [randomKey, kisiler] = availableItems[randomIndex];
        const malzemeObj = defaultMalzemeler.find(item => item.key === randomKey) || { label: randomKey, max: 1 };

        kisiler.push(formattedIsim);
        await set(ref(database, `kahvaltiListesi/${randomKey}`), kisiler);

        alert(`Rastgele seÃ§im yapÄ±ldÄ±! "${malzemeObj.label}" iÃ§in "${formattedIsim}" kaydedildi.`);
      } catch (error) {
        alert('Bir hata oluÅŸtu: ' + error.message);
      }
    };

    // TÃ¼m seÃ§imleri ve eklenen malzemeleri sÄ±fÄ±rlama fonksiyonu (parola kontrolÃ¼)
    window.sifirla = () => {
      // Ã–nce parola doÄŸrulama, sonra confirm
      if (!checkPassword()) return;
      if (confirm('TÃ¼m seÃ§imleri ve eklenen malzemeleri sÄ±fÄ±rlamak istediÄŸinize emin misiniz?')) {
        remove(dbRef).then(() => {
          alert('TÃ¼m seÃ§imler ve eklenen malzemeler sÄ±fÄ±rlandÄ±!');
        }).catch((error) => {
          alert('SÄ±fÄ±rlama sÄ±rasÄ±nda bir hata oluÅŸtu: ' + error.message);
        });

        remove(panoRef).then(() => {
          alert('Etkinlik bilgileri sÄ±fÄ±rlandÄ±!');
        }).catch((error) => {
          alert('Etkinlik bilgileri sÄ±fÄ±rlanÄ±rken bir hata oluÅŸtu: ' + error.message);
        });
      }
    };

    // Yeni malzeme ekleme fonksiyonu
    window.addMalzeme = () => {
      const yeniMalzeme = prompt('Yeni malzemenin adÄ±nÄ± girin:');
      const kisi = prompt('Bu malzemeyi kim getirecek? Ä°sim girin:');
      if (yeniMalzeme && kisi) {
        const formattedMalzeme = yeniMalzeme.trim();
        const formattedKisi =
          kisi.trim().charAt(0).toUpperCase() + kisi.trim().slice(1).toLowerCase();

        // KullanÄ±cÄ± tarafÄ±ndan eklenen malzemeler iÃ§in key, doÄŸrudan malzeme adÄ± olarak kullanÄ±lÄ±yor
        const itemRef = ref(database, `kahvaltiListesi/${formattedMalzeme}`);
        set(itemRef, [formattedKisi])
          .then(() => {
            alert(`${formattedMalzeme} listeye ${formattedKisi} tarafÄ±ndan eklendi.`);
          })
          .catch((error) => {
            alert('Malzeme eklenirken bir hata oluÅŸtu: ' + error.message);
          });
      } else {
        alert('GeÃ§erli bir malzeme adÄ± ve isim girin!');
      }
    };

    // Etkinlik panosu dÃ¼zenleme fonksiyonu (parola kontrolÃ¼)
    window.editPano = () => {
      // Ã–nce parola doÄŸrulama
      if (!checkPassword()) return;

      const tarih = prompt('Etkinlik tarihi (GG/AA/YYYY):');
      const saat = prompt('Etkinlik saati (SS:DD):');
      const yer = prompt('Etkinlik yeri:');

      update(panoRef, { tarih, saat, yer })
        .then(() => {
          alert('Etkinlik bilgileri gÃ¼ncellendi!');
        })
        .catch((error) => {
          alert('Etkinlik bilgileri gÃ¼ncellenirken bir hata oluÅŸtu: ' + error.message);
        });
    };

    // Malzeme seÃ§imini iptal etme fonksiyonu
    // ArtÄ±k editButton.onclick iÃ§inde parola ve confirm kontrolÃ¼ yapÄ±lÄ±yor.
    // Burada sadece veriyi temizleme iÅŸlemini yapÄ±yoruz.
    window.editMalzeme = (key) => {
      set(ref(database, `kahvaltiListesi/${key}`), [])
        .then(() => {
          alert(`SeÃ§im silindi.`);
        })
        .catch((error) => {
          alert('SeÃ§im silinirken bir hata oluÅŸtu: ' + error.message);
        });
    };
  </script>
</body>
</html>
